generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ORG_ADMIN
  HR
  OFFICER
  REVIEWER
  APPLICANT
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  ADDITIONAL_INFO_REQUIRED
}

enum LetterStatus {
  DRAFT
  SENT
  RECEIVED
  CC
  ARCHIVED
}

enum LetterType {
  HIERARCHICAL
  CROSS_STRUCTURE
  STAFF
  C_STAFF
  HEAD_OFFICE
  GUEST
}

enum Classification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
}

enum OrganizationType {
  MINISTRY
  AGENCY
  REGION
  SUB_ORGANIZATION
  OFFICE
  SOE
  ENTERPRISE
}

enum SubscriptionTier {
  STARTER
  CONSORTIUM
  NATIONAL
  ENTERPRISE_LITE
}

enum TenantStatus {
  PENDING
  REVIEWING
  APPROVED
  REJECTED
  PILOT
}

model Organization {
  id                   String           @id @default(uuid())
  name                 String
  code                 String           @unique
  type                 OrganizationType
  parentOrganizationId String?
  parentOrganization   Organization?    @relation("OrgHierarchy", fields: [parentOrganizationId], references: [id])
  subOrganizations     Organization[]   @relation("OrgHierarchy")
  phoneNumber          String?
  location             String?
  isActive             Boolean          @default(true)
  status               TenantStatus     @default(APPROVED) // Existing ones are approved by default
  subscriptionTier     SubscriptionTier @default(STARTER)
  maxUsers             Int              @default(100)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  users           User[]
  sentLetters     Letter[]   @relation("SenderOrg")
  receivedLetters Letter[]   @relation("RecipientOrg")
  ccLetters       LetterCC[]

  documents Document[]

  letterCounters   LetterCounter[]
  receivedMessages Message[]       @relation("RecipientOrg")
  templates        LetterTemplate[]
}

model RegistrationRequest {
  id               String           @id @default(uuid())
  orgName          String
  orgType          OrganizationType
  orgCode          String           @unique
  contactPerson    String
  officialEmail    String
  identitySystem   String // LDAP, PKI, None
  phone            String?
  intendedUse      String?          @db.Text
  status           TenantStatus     @default(PENDING)
  assignedTier     SubscriptionTier?
  reviewedById     String?
  reviewedBy       User?            @relation("RequestReviewer", fields: [reviewedById], references: [id])
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

model User {
  id             String        @id @default(uuid())
  fullName       String
  email          String        @unique
  passwordHash   String
  role           Role          @default(OFFICER)
  position       String?
  phoneNumber    String?
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  createdLetters  Letter[] @relation("LetterCreator")
  receivedLetters Letter[] @relation("LetterRecipient")
  stamps          Stamp[]

  documents        Document[] @relation("DocumentOwner")
  createdDocuments Document[] @relation("DocumentCreator")
  sentMessages Message[] @relation("MessageSender")
  reviewedRequests RegistrationRequest[] @relation("RequestReviewer")
}

model LetterTemplate {
  id             String       @id @default(uuid())
  name           String
  letterType     LetterType
  content        String       @db.Text
  isActive       Boolean      @default(true)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  letters Letter[]

  @@unique([name, organizationId])
}

model Letter {
  id              String         @id @default(uuid())
  referenceNumber String         @unique
  subject         String
  content         String         @db.Text
  letterType      LetterType
  status          LetterStatus   @default(DRAFT)
  classification  Classification @default(INTERNAL)
  headerImage     String?

  senderOrgId String?
  senderOrg   Organization? @relation("SenderOrg", fields: [senderOrgId], references: [id])

  recipientOrgId String?
  recipientOrg   Organization? @relation("RecipientOrg", fields: [recipientOrgId], references: [id])

  recipientUserId String?
  recipientUser   User?   @relation("LetterRecipient", fields: [recipientUserId], references: [id])

  createdById String
  createdBy   User   @relation("LetterCreator", fields: [createdById], references: [id])

  templateId String?
  template   LetterTemplate? @relation(fields: [templateId], references: [id])
  stampId    Int?
  stamp      Stamp?          @relation(fields: [stampId], references: [id])
  stampX     Float?
  stampY     Float?

  letterDate DateTime  @default(now())
  sentAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ccRecipients LetterCC[]
  attachments  LetterAttachment[]
  
  applicationStatus   ApplicationStatus @default(PENDING)
  messages            Message[]
}

model Message {
  id        String   @id @default(uuid())
  content   String   @db.Text
  letterId  String?
  letter    Letter?  @relation(fields: [letterId], references: [id])
  senderId  String
  sender    User     @relation("MessageSender", fields: [senderId], references: [id])
  
  recipientOrgId String?
  recipientOrg   Organization? @relation("RecipientOrg", fields: [recipientOrgId], references: [id])
  
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model LetterCC {
  id             String       @id @default(uuid())
  letterId       String
  letter         Letter       @relation(fields: [letterId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())

  @@unique([letterId, organizationId])
}

model LetterAttachment {
  id        String   @id @default(uuid())
  letterId  String
  letter    Letter   @relation(fields: [letterId], references: [id], onDelete: Cascade)
  fileName  String
  fileUrl   String
  fileSize  Int
  createdAt DateTime @default(now())
}

model LetterCounter {
  id             String        @id @default(uuid())
  orgId          String
  year           Int
  value          Int
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?

  @@unique([orgId, year])
}

model Document {
  id              String  @id @default(uuid())
  title           String
  referenceNumber String  @unique
  description     String?
  fileName        String
  fileUrl         String?
  fileSize        Int

  ownerId     String?
  owner       User?   @relation("DocumentOwner", fields: [ownerId], references: [id])
  createdBy   User    @relation("DocumentCreator", fields: [createdById], references: [id])
  createdById String

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  classification Classification @default(INTERNAL)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Stamp {
  id        Int      @id @default(autoincrement())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  imageUrl  String
  createdAt DateTime @default(now())

  letters Letter[]
}

model LandingPageContent {
  id           String   @id @default("hero")
  heroTitle    String   @default("IAM for everyone in your organization.")
  heroDesc     String   @default("The market leader trusted by 1.7 million customers. Manage your official correspondence with the security and efficiency of FIRMA.")
  featuresJson String   @default("[]")
  updatedAt    DateTime @updatedAt
}
