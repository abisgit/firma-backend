generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                   String           @id @default(uuid())
  name                 String
  code                 String           @unique
  type                 OrganizationType
  isActive             Boolean          @default(true)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  location             String?
  parentOrganizationId String?
  phoneNumber          String?
  maxUsers             Int              @default(100)
  status               TenantStatus     @default(APPROVED)
  subscriptionTier     SubscriptionTier @default(STARTER)
  documents            Document[]
  receivedLetters      Letter[]         @relation("RecipientOrg")
  sentLetters          Letter[]         @relation("SenderOrg")
  ccLetters            LetterCC[]
  letterCounters       LetterCounter[]
  templates            LetterTemplate[]
  receivedMessages     Message[]        @relation("RecipientOrg")
  parentOrganization   Organization?    @relation("OrgHierarchy", fields: [parentOrganizationId], references: [id])
  subOrganizations     Organization[]   @relation("OrgHierarchy")
  users                User[]
}

model RegistrationRequest {
  id             String            @id @default(uuid())
  orgName        String
  orgType        OrganizationType
  orgCode        String            @unique
  contactPerson  String
  officialEmail  String
  identitySystem String
  phone          String?
  intendedUse    String?
  status         TenantStatus      @default(PENDING)
  assignedTier   SubscriptionTier?
  reviewedById   String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  reviewedBy     User?             @relation("RequestReviewer", fields: [reviewedById], references: [id])
}

model User {
  id               String                @id @default(uuid())
  fullName         String
  email            String                @unique
  passwordHash     String
  role             Role                  @default(OFFICER)
  organizationId   String?
  isActive         Boolean               @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  phoneNumber      String?
  position         String?
  createdDocuments Document[]            @relation("DocumentCreator")
  documents        Document[]            @relation("DocumentOwner")
  createdLetters   Letter[]              @relation("LetterCreator")
  receivedLetters  Letter[]              @relation("LetterRecipient")
  sentMessages     Message[]             @relation("MessageSender")
  reviewedRequests RegistrationRequest[] @relation("RequestReviewer")
  stamps           Stamp[]
  organization     Organization?         @relation(fields: [organizationId], references: [id])
}

model LetterTemplate {
  id             String        @id @default(uuid())
  name           String
  letterType     LetterType
  content        String
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String?
  letters        Letter[]
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@unique([name, organizationId])
}

model Letter {
  id                String             @id @default(uuid())
  referenceNumber   String             @unique
  subject           String
  content           String
  letterType        LetterType
  status            LetterStatus       @default(DRAFT)
  classification    Classification     @default(INTERNAL)
  senderOrgId       String?
  recipientOrgId    String?
  recipientUserId   String?
  createdById       String
  templateId        String?
  letterDate        DateTime           @default(now())
  sentAt            DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  stampId           Int?
  stampX            Float?
  stampY            Float?
  headerImage       String?
  applicationStatus ApplicationStatus  @default(PENDING)
  createdBy         User               @relation("LetterCreator", fields: [createdById], references: [id])
  recipientOrg      Organization?      @relation("RecipientOrg", fields: [recipientOrgId], references: [id])
  recipientUser     User?              @relation("LetterRecipient", fields: [recipientUserId], references: [id])
  senderOrg         Organization?      @relation("SenderOrg", fields: [senderOrgId], references: [id])
  stamp             Stamp?             @relation(fields: [stampId], references: [id])
  template          LetterTemplate?    @relation(fields: [templateId], references: [id])
  attachments       LetterAttachment[]
  ccRecipients      LetterCC[]
  messages          Message[]
}

model Message {
  id             String        @id @default(uuid())
  content        String
  letterId       String?
  senderId       String
  recipientOrgId String?
  isRead         Boolean       @default(false)
  createdAt      DateTime      @default(now())
  letter         Letter?       @relation(fields: [letterId], references: [id])
  recipientOrg   Organization? @relation("RecipientOrg", fields: [recipientOrgId], references: [id])
  sender         User          @relation("MessageSender", fields: [senderId], references: [id])
}

model LetterCC {
  id             String       @id @default(uuid())
  letterId       String
  organizationId String
  createdAt      DateTime     @default(now())
  letter         Letter       @relation(fields: [letterId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([letterId, organizationId])
}

model LetterAttachment {
  id        String   @id @default(uuid())
  letterId  String
  fileName  String
  fileUrl   String
  fileSize  Int
  createdAt DateTime @default(now())
  letter    Letter   @relation(fields: [letterId], references: [id], onDelete: Cascade)
}

model LetterCounter {
  id             String        @id @default(uuid())
  orgId          String
  year           Int
  value          Int
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@unique([orgId, year])
}

model Document {
  id              String         @id @default(uuid())
  title           String
  referenceNumber String         @unique
  description     String?
  fileName        String
  fileUrl         String?
  fileSize        Int
  ownerId         String?
  createdById     String
  organizationId  String?
  classification  Classification @default(INTERNAL)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       User           @relation("DocumentCreator", fields: [createdById], references: [id])
  organization    Organization?  @relation(fields: [organizationId], references: [id])
  owner           User?          @relation("DocumentOwner", fields: [ownerId], references: [id])
}

model Stamp {
  id        Int      @id @default(autoincrement())
  userId    String
  imageUrl  String
  createdAt DateTime @default(now())
  letters   Letter[]
  user      User     @relation(fields: [userId], references: [id])
}

model LandingPageContent {
  id           String   @id @default("hero")
  heroTitle    String   @default("IAM for everyone in your organization.")
  heroDesc     String   @default("The market leader trusted by 1.7 million customers. Manage your official correspondence with the security and efficiency of FIRMA.")
  featuresJson String   @default("[]")
  updatedAt    DateTime @updatedAt
}

enum Role {
  SUPER_ADMIN
  ORG_ADMIN
  OFFICER
  REVIEWER
  HR
  APPLICANT
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  ADDITIONAL_INFO_REQUIRED
}

enum LetterStatus {
  DRAFT
  SENT
  RECEIVED
  CC
  ARCHIVED
}

enum LetterType {
  HIERARCHICAL
  CROSS_STRUCTURE
  STAFF
  C_STAFF
  HEAD_OFFICE
  GUEST
}

enum Classification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
}

enum OrganizationType {
  MINISTRY
  AGENCY
  REGION
  SUB_ORGANIZATION
  OFFICE
  SOE
  ENTERPRISE
}

enum SubscriptionTier {
  STARTER
  CONSORTIUM
  NATIONAL
  ENTERPRISE_LITE
}

enum TenantStatus {
  PENDING
  REVIEWING
  APPROVED
  REJECTED
  PILOT
}
